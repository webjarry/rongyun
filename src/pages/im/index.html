<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>视频聊天</title>
    <link rel="stylesheet" href="../../assets/style/css/Common.css">
</head>
<body>

<div class="container">
    <div class="main">
        <div class="wrapper">
            <div class="live" id="live">

            </div>
            <div class="message">
                <div class="message-container">
                    <div class="message-header">
                        <span>聊天框</span>
                    </div>
                    <div class="message-main">
                        <div class="row message-content" id="message-li"></div>
                    </div>
                    <div class="message-footer">
                        <div class="content">
                            <textarea rows="10" id="message"></textarea>
                        </div>
                        <div class="footer-submit">
                            <div class="desc"><span>按Enter键发送，按Ctrl+Enter键换行</span></div>
                            <div class="submit">
                                <button onclick="answerMessage()">接听通话</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="prop">
        <div class="title">
            <h3>您有一个新的通话邀请</h3>
        </div>

        <div class="prop-footer">
            <div class="y" onclick="answerMessage()">
                <span>接听</span>
            </div>
            <div class="n" onclick="refuseMessage()">
                <span>挂断</span>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.ronghub.com/RongIMLib-2.5.5.min.js"></script>
<script src="https://cdn.ronghub.com/RongCallLib-3.1.5.min.js"></script>
<script src="https://cdn.ronghub.com/RongRTC-3.2.0.min.js"></script>
<script type="text/javascript" src="../../lib/rongcloud.js"></script>
<script type="text/javascript">
    let rong = new RongCloud('lmxuhwagl5a3d'),
        token = 'Yfb2RlByKO4mm/wiZEw9vaZM1JITiRXniSoxowdOvP1Ias76yALBk+XMLuFA2I6eyIJ3gOKEzrv84t1y7Hk7Sw==';

    let msg = document.getElementById('message');

    let dom = document.getElementById('message-li');

    // 连接聊天
    rong.connect(token).then(res => {
        console.log('连接成功', res);
    });

    // 监听消息
    rong.message((message) => {
        addElementMessage('he', message.content.content)
    });

    var config = {
        timeout: 20000,
        RongIMLib: RongIMLib,
        RongRTC: RongRTC
    };
    var rongCallLib = RongCallLib.init(config);

    $("#message").keydown(function(event){
        let isEnter = event.keyCode === 13 || event.which === 13,
            values = document.getElementById('message').value;

        /**
         * 组合键换行
         * 回车键发送消息
         * */
        if(event.ctrlKey && isEnter) {
            msg.value += '\n';
        } else if (isEnter){
            // 携带内容
            submitMessage(values);
            return false;
        }
    });

    // 接听通话
    function answerMessage() {
        rong.answerCall()
    }

    // 拒绝通话
    function refuseMessage() {
        rong.refuseCall()
    }

    // 发送消息
    function submitMessage(value) {
        rong.submitMessage(value, '36').then(res => {
            addElementMessage('me', res.content.content);
            msg.value = '';
        }).catch(error => {
            console.log('消息发送失败!')
        })
    }

    /**
     * params type: 'he' / 'me'
     * */
    function addElementMessage(type, message) {
        let box = document.createElement('div'),
            col = document.createElement('div'),
            text = document.createElement('span');
        box.className = type;
        col.className = 'col';
        text.innerText = message;
        box.append(col);
        col.append(text);
        dom.append(box);
    }

    var videoWatcher = function(result) {
        var type = result.type;
        var boxEl = document.getElementById('live');
        if (type === 'added') {
            // 添加音视频节点
            let video = result.data;
            boxEl.appendChild(video);
        } else if (type === 'removed') {
            // 删除对应音视频节点
            let video = result.data;
            boxEl.removeChild(video);
        } else if (type == 'leave') {
            // 音视频结束, 清空所有音视频 UI
        }
    };
    rongCallLib.videoWatch(videoWatcher);

    var commandWatcher = function(message) {
        var messageType = message.messageType;
        // 根据消息类型做对应处理
        console.log('发送视频', messageType);
        switch (messageType) {
            case "InviteMessage":
                $('.prop').show(300);
                break;
            case "SummaryMessage":
                $('.prop').hide(300);
                break;
            default:
                break
        }

    };
    rongCallLib.commandWatch(commandWatcher);
</script>
</body>
</html>
