<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>视频聊天</title>
    <link rel="stylesheet" href="../../assets/style/css/Common.css">
</head>
<body>

<div class="container">
    <div class="main">
        <div class="wrapper">
            <div class="live" id="live"></div>
            <div class="message">
                <div class="message-container">
                    <div class="message-header">
                        <span>聊天框</span>
                    </div>


                    <div class="message-main" id="gd">
                        <div class="row message-content" id="message-li"></div>
                    </div>


                    <div class="message-footer">
                        <div class="content">
                            <textarea rows="10" id="message"></textarea>
                        </div>
                        <div class="footer-submit">
                            <div class="desc"><span>按Enter键发送，按Ctrl+Enter键换行</span></div>
                            <div class="submit">
                                <button onclick="submitMessage(document.getElementById('message').value)">发送消息</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="prop">
        <div class="title">
            <h3>您有一个新的通话邀请</h3>
        </div>

        <div class="prop-footer">
            <div class="y" onclick="answerMessage()">
                <span>接听</span>
            </div>
            <div class="n" onclick="refuseMessage()">
                <span>挂断</span>
            </div>
        </div>
    </div>
    <div class="textMenu" id="menu">
        <div class="item" onclick="closeMessage()">
            <span>清空聊天内容</span>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.ronghub.com/RongIMLib-2.5.5.min.js"></script>
<!--<script type="text/javascript" src="../../utils/RongIMLib.js"></script>-->
<script src="https://cdn.ronghub.com/RongCallLib-3.1.5.min.js"></script>
<script src="https://cdn.ronghub.com/RongRTC-3.2.0.min.js"></script>
<script type="text/javascript" src="../../lib/rongcloud.js"></script>
<script type="text/javascript" src="../../components/Toast.js"></script>
<script type="text/javascript">
    let rong = new RongCloud('lmxuhwagl5a3d'),
        token = 'n1Da50a9scEftrUuqanZAKZM1JITiRXniSoxowdOvP1Ias76yALBk6LMi8bTcQ10xlyzneCoR2z84t1y7Hk7Sw==',
        msgItem = document.getElementById('gd'), // 滚动容器
        msg = document.getElementById('message'),  // 输入内容
        menu = document.getElementById('menu'),
        messages = {
            list: [],   // 消息历史记录
            dom: document.getElementById('message-li')   // 插入消息容器
        };
    // 连接聊天
    rong.connect(token).then(id => {
        boxScroll(msgItem);

        // 监听消息
        rong.message((message) => {
            addElementMessage('he', message.content.content);
            boxScroll(msgItem);
        });

        // 获取历史记录
        rong.recording(20, '36').then((res) => {
            res.forEach((item) => {
                addElementMessage(id === item.senderUserId
                    ? 'me'
                    : 'he',
                    item.content.content
                );
            });
            messages.list = res;
            boxScroll(msgItem);
        }).catch(error => {
            console.log('Error', error)
        });

        // 滚动到最顶部获取历史记录
        // msgItem.onscroll = function (ev) {
        //     if (msgItem.scrollTop > 0) return false;
        //     // 获取历史记录
        //     rong.recording(20, '36', messages.list[messages.list.length - 1].sentTime).then((res) => {
        //         res.forEach((item) => {
        //             addElementMessage(id === item.senderUserId
        //                 ? 'me'
        //                 : 'he',
        //                 item.content.content
        //             );
        //         });
        //         messages.list = res;
        //     }).catch(error => {
        //         console.log('Error', error)
        //     });
        // };
    });

    var config = {
        timeout: 20000,
        RongIMLib: RongIMLib,
        RongRTC: RongRTC
    };
    var rongCallLib = RongCallLib.init(config);

    $("#message").keydown(function(event){
        let isEnter = event.keyCode === 13 || event.which === 13,
            values = document.getElementById('message').value;

        /**
         * 组合键换行
         * 回车键发送消息
         * */
        if(event.ctrlKey && isEnter) {
            msg.value += '\n';
        } else if (isEnter){
            // 携带内容
            submitMessage(values);
            return false;
        }
    });

    // 接听通话
    function answerMessage() {
        rong.answerCall()
    }

    // 拒绝通话
    function refuseMessage() {
        rong.refuseCall()
    }

    // 发送消息
    function submitMessage(value) {
        if (value === '') return false;

        rong.submitMessage(value, '36').then(res => {
            addElementMessage('me', res.content.content);
            msg.value = '';

            boxScroll(msgItem);
        }).catch(error => {
            console.log('消息发送失败!')
        })
    }

    /**
     * params type: 'he' / 'me'
     * */
    function addElementMessage(type, message) {
        let box = document.createElement('div'),
            col = document.createElement('div'),
            text = document.createElement('span');
        box.className = type;
        col.className = 'col';
        text.innerText = message;
        box.append(col);
        col.append(text);
        messages.dom.append(box);
    }

    var videoWatcher = function(result) {
        var type = result.type;
        var boxEl = document.getElementById('live');
        if (type === 'added') {
            // 添加音视频节点
            let video = result.data;
            boxEl.appendChild(video);
        } else if (type === 'removed') {
            // 删除对应音视频节点
            let video = result.data;
            boxEl.removeChild(video);
        } else if (type == 'leave') {
            // 音视频结束, 清空所有音视频 UI
        }
    };

    rongCallLib.videoWatch(videoWatcher);

    var commandWatcher = function(message) {
        var messageType = message.messageType;
        // 根据消息类型做对应处理
        switch (messageType) {
            case "InviteMessage":
                $('.prop').addClass('active');
                break;
            case "SummaryMessage":
                $('.prop').removeClass('active');
                break;
            default:
                break
        }

    };

    rongCallLib.commandWatch(commandWatcher);

    function boxScroll(o){
        o.scrollTop = o.scrollHeight;
    }

    // 自定义鼠标右键
    msgItem.oncontextmenu = function (ev) {
        ev.preventDefault();
        menu.style.display = 'block';
        menu.style.top = ev.clientY + 'px';
        menu.style.left = ev.clientX + 'px';
    };

    msgItem.onclick = function (ev) {
        menu.style.display = 'none';
    };

    function closeMessage() {
        console.log('清空聊天记录!');
        menu.style.display = 'none';
    }
</script>
</body>
</html>
